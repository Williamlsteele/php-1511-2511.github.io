---
title: "Logistic Regression"
author: "Adam J Sullivan, PhD"
date: "02/26/2018"
output:
   ioslides_presentation: 
    widescreen: true
notes: ''
link: yes
slides: yes
layout: page
css:  "C:/Users/adam_/Dropbox (Personal)/Brown/Teaching/Brown Courses/PHP2511/Spring 2018/website/php-1511-2511.github.io/Notes/slides.css"
---

```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(results="hold")
knitr::opts_chunk$set(cache=F)
```




##Simple Logistic Regression

- We will begin with an example of simple logistic regression with a sample of the [Western Collaborative Group Study](https://clinicaltrials.gov/ct2/show/NCT00005174). 
- This study began in 1960 with 3154 men ages 39-59, who were employed in one of 11 California based companies. 
- They were followed until 1969 during this time, 257 of these men developed coronary heart disease (CHD). 
- You can read this data in with the code below. 

## Reading in the Data

```{r, tidy=TRUE}

library(haven)
wcgs <- read_dta("wcgs2.dta")
wcgs <- wcgs[,-16]
```

## The Variables


-----------------------------------------------------------
Name    Description
------- -------------------------------------------
id      Subject identification number


age     Age in years

height  Height in inches

weight  Weight in lbs.

sbp     Systolic blood pressure in mm 

dbp     Diastolic blood pressure in mm Hg
----------------------------------------------------

## The Variables



-----------------------------------------------------------
Name    Description
------- -------------------------------------------
chol    Fasting serum cholesterol in mm 

behpat  Behavior

        1 = A1

        2 = A2

        3 = B3

        4 = B4
----------------------------------------------


## The Variables





-----------------------------------------------------------
Name    Description
------- -------------------------------------------
ncigs   Cigarettes per day

dibpat  Behavior

        1 = type A

        2 = type B

chd69   Coronary heart disease

        1 = Yes

        0 = no
----------------------------------------------

## The Variables


-----------------------------------------------------------
Name    Description
------- -------------------------------------------
typechd Type of CHD

        1 = myocardial infarction or death

        2 = silent myocardial infarction

        3 = angina perctoris

time169 Time of CHD event or end of follow-up
----------------------------------------------------


## The Variables

-----------------------------------------------------------
Name    Description
------- -------------------------------------------
arcus   Arcus senilis

        0 = absent

        1 = present

bmi     Body Mass Index
-----------------------------------------------------------



## Continuous Covariate 

- We will first consider the relationship between age and CHD. 
- We could first consider boxplots



```{r, echo=FALSE}
library(ggplot2)
library(tidyverse)
wcgs <- wcgs %>% mutate(chd69 = as.factor(chd69))
ggplot(wcgs, aes(chd69, age)) + geom_boxplot() + xlab("CHD") + ylab("Age") 

```


## What do we see?

- This displays that the group with CHD appears older than the group without a CHD. 
- To check if there is an increased probability of CHD due to being older we will fit the following logistic regression. 
$$logit(p_{CHD}) = \hat{\beta}_0 + \hat{\beta}_1 Age$$

## 

```{r}
library(broom)

fit.cont <- glm(chd69 ~ age, data=wcgs, family=binomial(link="logit"))
tidy(fit.cont, conf.int=TRUE)[,-c(3:4)]

```


## What can we conclude?

- From here he can reject the null hypothesis and conclude that $\beta\ne0$ and further more show that the probability of having CHD increases with age. 



## Dichotomous Covariate

- We could then consider the relationship between CHD and Arcus Senilis:

```{r, echo=FALSE}
tab <- wcgs %>% group_by(chd69, arcus) %>% tally()
knitr::kable(tab)
```



## An Easier Format

----------------------------
 &nbsp;    absent   present   
--------- -------- --------- 
 **no**     2058      839    

 **yes**    153       102    
----------------------------



## Analysis from Epidemiology Class

- We can see from this table that what we have here is a typical $2\times2$ table that many of you have seen. 
- In epidemiology you learned how to work with these and probably learned that you can calculate the odds ratio as shown below:
$$\dfrac{2058\cdot102}{153\cdot839} = 1.63528$$

## What do we have then?

We can then find the following:

  * Pearson $\chi^2 = 13.64$, p-value=0.000221
  * 95% Woolf CI (1.257, 2.127)

## Why not Logistic Regression?

- We can answer this same type of question with logistic regression:
$$\log\left(\dfrac{p_x}{1-p_x}\right) = \beta_0+\beta_1x$$
- This is nothing more than the log odds. 
- Or we can list this as:
$$p_x = \dfrac{\exp\left(\beta_0+\beta_1x\right)}{1+\exp\left(\beta_0+\beta_1x\right)}.$$

## What do we have then?

This leads to
$$
\begin{aligned}
\log\left(\dfrac{p_1}{1-p_1}\right) = \beta_0+\beta_1 &\Rightarrow p_1 = \dfrac{\exp\left(\beta_0+\beta_1\right)}{1+\exp\left(\beta_0+\beta_1\right)} \\
\log\left(\dfrac{p_0}{1-p_0}\right) = \beta_0 & \Rightarrow  p_0 = \dfrac{\exp\left(\beta_0\right)}{1+\exp\left(\beta_0\right)}\\
\end{aligned}
$$

## What does this mean?

- We then can find a way to estimate all probabilities associated with this problem. 
- We can find the probability that someone with Arcus Senilis present has the disease or does not have the disease. 
- We can also find the same for those with the absence of Arcus Senilis. 

## Saturated Model

- We refer to this as a ***Saturated Model***, where we can define the probabilities of all relationships. 
- This works in our models because we only need to estimate 2 probabilities and we have 2 coefficients so we can estimate everything:

## The math

$$
\begin{aligned}
\beta_0 &= \log\left(\dfrac{p_0}{1-p_0}\right)\\
\beta_1 &= \log\left(\dfrac{p_1}{1-p_1}\right) - \beta_0\\
&= \log\left(\dfrac{p_1}{1-p_1}\right) - \log\left(\dfrac{p_0}{1-p_0}\right)\\
&= \log\left(\dfrac{\left(\dfrac{p_1}{1-p_1}\right)}{\left(\dfrac{p_0}{1-p_0}\right)}\right)\\
&= \log\left( \dfrac{\text{Odds of CHD in Arcus Present Group}}{\text{Odds of CHD in Arcus Absent Group}}\right)\\
&= \log\left( \text{Odds Ratio}\right)
\end{aligned}
$$

## What does this mean? 

-This shows us that $\beta_1$ is the log odds ratio comparing those with Arcus Senilis vs those without it. 


$$
\begin{aligned}
\beta_1 &= \log\left( \text{Odds Ratio}\right)\\
\text{Odds Ratio} &= \exp\left(\beta_1\right)\\
\end{aligned}
$$


## What about our Estimates?

- Thus with our data we can estimate:
$$\widehat{\log\left(OR\right)} = \hat{\beta_1}\text{ or } \widehat{OR} = \exp\left(\hat{\beta}_1\right)$$
- We can fit this model now using out logistic regression model:

## Lets Fit this!

```{r}

fit.bin <- glm(chd69 ~ arcus, data=wcgs, family=binomial(link="logit"))
tidy(fit.bin, exponentiate = TRUE, conf.int=TRUE)[,-c(3:4)]
```



## What do we Notice?

- We can see that we have that $\hat{\beta}_1=$ `r summary(fit.bin)$coef[2,1]`. 
- This is the log odds so if we exponentiate that we have that the Odds ratio is, `r exp(summary(fit.bin)$coef[2,1])`.
- Then we can also exponentiate  both the lower and upper elements of the confidence intervals to get a 95% confidence interval for the Odds Ratio of (`r exp(confint(fit.bin)[2,1])`, `r exp(confint(fit.bin)[2,2])` ). 
- Aside from rounding differences this is the same as what you would have found before. 



## Interpretation of Coefficients

- Let's consider a 1 unit change in $x$:
$$
\begin{aligned}
p_x = \Pr(Y=1|covariate x) &= \dfrac{\exp(\beta_0 + \beta_1x)}{1+\exp(\beta_0 + \beta_1x)}\\
p_{x+1} = \Pr(Y=1|covariate x+1) &= \dfrac{\exp(\beta_0 + \beta_1(x+1))}{1+\exp(\beta_0 + \beta_1(x+1))}\\
\end{aligned}
$$

## Interpretation of Coefficients

- Then the Odds Ratio associated with a 1 unit increase in $x$ is:
$$
\begin{aligned}
\text{OR} &= \dfrac{\dfrac{p_{x+1}}{1-p_{x+1}}}{\dfrac{p_{x}}{1-p_{x}}}\\
&= \exp\left[ \beta_0 + beta_1(x+1) - \beta_0 - \beta_1x \right]\\
&= e^{\beta_1}\\
\end{aligned}
$$

##  Interpretation of Coefficients

- If we want to consider a unit increase of 2 in $x$ we would have:
$$\text{OR} = \exp(\beta_1\cdot2) = e^{2\beta_1}= e^{\beta_1}e^{\beta_1}$$

## Continuous Covariate

- This means given our continuous covariate, age, we have the following interpretation:
    * If we have 2 people who differ in age by one year the older person would have on average an increased log odds of `r summary(fit.cont)$coef[2,1]`. 
    ***This however does not have much meaning to us. We need to place this in terms that we can understand. To do this we recall from above that the change in odds ratio is actually $e^{\beta_1}$. ***


## Continuos Covariate

* If there are 2 people who differ in age by one year the older person would on average have an odss of CHD `r exp(summary(fit.cont)$coef[2,1])` times that of the younger. 
* On average a person has an odds of CHD  `r exp(summary(fit.cont)$coef[2,1])-1` higher than someone a year younger. 
* On average a person has an odds of CHD `r (exp(summary(fit.cont)$coef[2,1])-1)*100`% higher than someone a year younger. 

##Binary Covariate

- Given our binary case we have the following interpretation. 
    * On average a person with Arcus Senilis present has an odds of CHD `r exp(summary(fit.bin)$coef[2,1])` times that of the odds of CHD for another person with absence of Arcus Senilis.
    * On average a person with Arcus Senilis present has an odds of CHD `r (exp(summary(fit.bin)$coef[2,1])-1)*100`% higher than the odds of CHD for another person with absence of Arcus Senilis. 

## Final Interpretation Notes

- We can see that there are multiple ways to interpret these just as in linear regression. 
- ***Remember to exponentiate your estimate in R*** so that it can be interpreted in more meaningful units. 

 

## Multiple Logistic Regression

When we work with clinical and epidemiological data we tend to focus on mutliple predictors. For example:
* A few categorical predictors
    * Contingency Tables
    * Stratified Contingency Tables
* Continuous or many predictors
    * Logistic Regression
    
## Our Model
    
- Our model is similar to before:
$$logit(\Pr(Y=1|X_1, \ldots, X_p)) = \beta_0 + \beta_1X_1 + \cdots + \beta_pX_p$$
- This implies that

$$\Pr(Y=1|X_1,\ldots,X_p) = \dfrac{\exp\left( \beta_0 + \beta_1X_1 + \cdots + \beta_pX_p\right)}{1 + \exp\left( \beta_0 + \beta_1X_1 + \cdots + \beta_pX_p\right)} $$


## Interpeting the Model

- With multiple logistic regression we have the following interpretations:
    -  $\beta_0$ which is the log odds that $Y=1$ among those with $\beta_1=\cdots=\beta_p=0$. 
    - $\beta_j$ is the log odds ratio
        - This characterizes the association of $X_j$ on the odds of $Y=1$.
        - Conditional on all other covariates. 
    
##An Example

- We will continue exploring the WCGS data. 
- This time we will use a multiple logistic regression model with the following covariates:
    * Age
    * Arcus Senilis
    * Cholesterol
    * Systolic Blood Pressure

## Fitting the Model

- We fit this model using R in the same fashion as the simple logistic model. 


```{r, eval=F}
fit.mult <- glm(chd69 ~ age + arcus + chol + sbp, data=wcgs, family=binomial(link="logit"))
tidy(fit.mult, conf.int=TRUE, exponentiate=TRUE)
```



## Fitting the Model



```{r, echo=F}
fit.mult <- glm(chd69 ~ age + arcus + chol + sbp, data=wcgs, family=binomial(link="logit"))
tidy(fit.mult, conf.int=TRUE, exponentiate=TRUE)
```


##  What can we do?


- Calculate the log odds of CHD for a 60 year old with 253 mg/dL of  total cholesterol, 136 mmHg SBP and the presence of Arcus Senilis. 
- We achieve this solution by taking our regression equation and intserting the values from the problem. 

```{r}
    log.odd <-fit.mult$coefficients[1] + fit.mult$coefficients[2]*60 + fit.mult$coefficients[3]*1 + fit.mult$coefficients[4]*253 +     fit.mult$coefficients[5]*136
    log.odd
```

## What can we do?

-  Calculate the probability of CHD for a 60 year old with 253 mg/dL of  total cholesterol, 136 mmHg SBP and the presence of Arcus Senilis. 

```{r}
    exp(log.odd)/(1 + exp(log.odd))
```
    