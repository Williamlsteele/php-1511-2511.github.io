---
title: "Factors and Interactions"
author: "Adam J Sullivan, PhD"
date: "02/05/2018"
output:
   ioslides_presentation: 
    widescreen: true
notes: ''
link: yes
slides: yes
layout: page
css:  "C:/Users/adam_/Dropbox (Personal)/Brown/Teaching/Brown Courses/PHP2511/Spring 2018/website/php-1511-2511.github.io/Notes/slides.css"
---

```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(results="hold")
knitr::opts_chunk$set(cache=F)
```


# Factors

## What are Factors? 

- Factors are categorical data. 
- Factors contain
    - Levels
    - Can be numerical or character data


## Why do we use them? 

- Factors allow us to group things by category. 
- Factors create dummy variables or indicator variables in our regressions. 

## What is an indicator variable?

- Consider the scenario where we have 3 treatments: A, B, & C
- We could have two indicator variables:
    - I(Treat_A) is
        - 1 if patient is on treatment A
        - 0 if patient is not on treatment A
    - I(Treat_B) is
        - 1 if patient is on treatment B
        - 0 if patient is not on treatment B
    - Treatment C would be both:
        - I(Treat_A) = 0
        - I(Treat_B) = 0
        
## What does this mean in regressions? 

- Indicator variables change the regression:
$$Outcome = \beta_0 + \beta_1 Age + \beta_2 I(Treat_A) + \beta_3 I(Treat_B)$$
- For a person on Treatment A:
$$Outcome = (\beta_0  + \beta_2 ) + \beta_1 Age$$
- For a person on Treatment B:
$$Outcome = (\beta_0  + \beta_3 ) + \beta_1 Age$$
- For a person on Treatment C:
$$Outcome = \beta_0  + \beta_1 Age$$

## What does this mean in Regression?

- We can see that a factor leads to multiple different regression lines. 
- Each line then has a different intercept than the others. 
- In this regression age has the same effect, just the baseline is different. 

## Are there different types of factors?

- We can have different types of factors
    - Nominal
    - Ordinal

## Nominal Factors

- Nominal factors are factors that represent named categories. 
- These are categories that do not have an intrinsic ordering. 
- Examples:
    - Gender
    - Sex
    - Race/ethnicity
- We must treat these as indicator variables in models. 

## Ordinal Factors

- Ordinal factors are factors that represent some ordered categories. 
- These factors have an intrinsic ordering. 
- Examples:
    - Likert Scales (Poor, Neutral, Good)
    - BMI (Underweight, Normal, Overweight, Obese)
    - Age Groups (under 18, 18-25, 25-35, 35+)
- In regression models can be indicator variables or a trend. 

## Indicator Variables vs Trends

- We saw with indicator variables that we have multiple variables to represent the factor. 
- Each category leads to a different regression. 
- Consider this: 
$$ Outcome = \beta_0 + \beta_1 age + \beta_2 I(BMI = underweight) + \beta_3 I(BMI=Overweight+)$$
- We then have 3 different regressions:
    - 1 for normal BMI
    - 1 for underweight BMI
    - 1 for overweight+ BMI
    
## Our 3 regressions

- Normal BMI
$$Outcome =\beta_0 + \beta_1 age$$
- Underweight BMI
$$Outcome =(\beta_0 + \beta_2) + \beta_1 age$$
- Overweight+ BMI
$$Outcome =(\beta_0+ \beta_3) + \beta_1 age$$


## Indicator Variables vs Trends

- With a trend we allow the factor to have one slope. 
- Instead of 1 category leading to a new regression, each category leads to a further increase. 
- Our model
$$Outcome =\beta_0 + \beta_1 age + \beta_2 BMI$$


## Our Regressions

- Normal BMI
$$Outcome =\beta_0 + \beta_1 age$$
- Underweight BMI
$$Outcome =(\beta_0 + \beta_2) + \beta_1 age$$
- Overweight+ BMI
$$Outcome =(\beta_0+ 2\beta_2) + \beta_1 age$$







## What is the difference? 

- You can see that it appears that we still have 3 regressions. 
- indicator variable regression, each group can have a unique change from the baseline. 
    - $\beta_{group=2}\ne\beta_{group=3}$
- trend regression, each group has the same difference between them 

## An example: PBC Data

- This data is from the Mayo Clinic trial in primary biliary cirrhosis (PBC) of the liver conducted between 1974 and 1984. 
- A total of 424 PBC patients, referred to Mayo Clinic during that ten-year interval, met eligibility criteria for the randomized placebo controlled trial of the drug D-penicillamine. 
- The first 312 cases in the data set participated in the randomized trial and contain largely complete data. 
- The additional 112 cases did not participate in the clinical trial, but consented to have basic measurements recorded and to be followed for survival. 

## PBC Data 


| Variable | Description | 
| :--------: | :----------- | 
| age | 	in years | 
| albumin | 	serum albumin (g/dl) | 
| alk.phos | 	alkaline phosphotase (U/liter)| 
| ascites | 	presence of ascites | 
| ast | 	aspartate aminotransferase, once called SGOT (U/ml) | 
| bili | 	serum bilirunbin (mg/dl) | 

## PBC Data 


| Variable | Description | 
| :--------: | :----------- | 
| chol | 	serum cholesterol (mg/dl) | 
| copper | 	urine copper (ug/day) | 
| edema | 	0 no edema, 0.5 untreated or successfully treated | 
|  | 1 edema despite diuretic therapy | 
| hepato | 	presence of hepatomegaly or enlarged liver | 
| id | 	case number | 

## PBC Data 


| Variable | Description | 
| :--------: | :----------- | 
| platelet | 	platelet count | 
| protime | 	standardised blood clotting time | 
| sex | 	m/f | 
| spiders | 	blood vessel malformations in the skin   | 
| stage | 	histologic stage of disease (needs biopsy) | 
| status | 	status at endpoint, 0/1/2 for censored, transplant, dead | 



## PBC Data 


| Variable | Description | 
| :--------: | :----------- | 
| time | 	number of days between registration and the earlier of death, transplantion, or study analysis in July, 1986   | 
| trt | 	1/2/NA for D-penicillmain, placebo, not randomised |
| trig | 	triglycerides (mg/dl) |


## Data

```{r}
library(survival)
pbc
```


## Consider Trends vs Indicators

```{r}
library(tidyverse)
pbc <- pbc %>%
      filter(!is.na(stage)) %>%
      mutate(stage_dummy = as.factor(stage)) %>%
      mutate(mean_cent_age= age-mean(age))
```



## Regression plot with trend:

```{R, eval=F}
library(ggplot2)
ggplot(pbc, aes(mean_cent_age, platelet, color=stage)) + geom_smooth(method="lm", se=FALSE)
```



## Regression plot with trend:

```{R, echo=F}
library(ggplot2)
ggplot(pbc, aes(mean_cent_age, platelet, color=stage)) + geom_smooth(method="lm")
```


## Regression plot with Indicators:

```{R, eval=F}
library(ggplot2)
ggplot(pbc, aes(mean_cent_age, platelet, color=stage_dummy)) + geom_smooth(method="lm")
```



## Regression plot with Indicators:

```{R, echo=F}
library(ggplot2)
ggplot(pbc, aes(mean_cent_age, platelet, color=stage_dummy)) + geom_smooth(method="lm", se=FALSE)
```


## Regressions: Trend

```{r}
library(broom)
mod1 <- lm(data=pbc, platelet~mean_cent_age + stage)
tidy(mod1)
```


## Interpretations

- age: For 2 people with the same disease stage, a person 1 year older has an average platelet count of 1 less than the younger person. 
- stage: For 2 people of the same age, a person 1 disease stage higher has an average platelet count 25 less than the person with the lower disease stage. 



## Regressions: Trend

```{r}
library(broom)
mod2 <- lm(data=pbc, platelet~age + stage_dummy)
tidy(mod2)
```



## Interpretations


- age: For 2 people with the same disease stage, a person 1 year older has an average platelet count of 1 less than the younger person. 
- stage_dummy 2: For 2 people of the same age, a person in diease stage 2 higher has an average platelet count 2 less than the person with disease stage 1. 
- stage_dummy 3: For 2 people of the same age, a person in diease stage 3 higher has an average platelet count 27 less than the person with disease stage 1.
- stage_dummy 4: For 2 people of the same age, a person in diease stage 4 higher has an average platelet count 60 less than the person with disease stage 1. 

## Is there a difference?

- Yes!!
- If we look between diease stage 1 and 2 the difference is on average 2 in the model with dummy variables. 
- In the trend model the difference between any 2 stages is on average 25. 

## Is this difference Significant?

- We can test for significane with the F-test
```{R}
anova(mod1,mod2)
```
- Based on our test, the trend gives us just as much information. 


## How about $R^2$

```{r}
library(broom)
glance1 <- glance(mod1)[,c(1:2)]
glance2 <- glance(mod2)[,c(1:2)]
bind_rows(glance1, glance2)
```

# Interaction


## Interaction

- The definition of interaction is the direct effect that one kind of particle has on another.
- This is similar to how we view it in statistics. 
- When there is an interaction, the effect of one variable is different in one group than in another. 
- For example, if we feel there is a interaction between sex and treatment, then the effect of ones treatment is directly related to what their sex is. 



## Example with Categorical Interaction

- This data is from 18 women and 14 men to investigate a certain theory on why women exhibit a lower tolerance for alcohol and develop alcohol–related liver disease more readily than men.
- This data is from [The Statistical Sleuth: A Course in Methods of Data Analysis](http://www.statisticalsleuth.com/)

## Example with Categorical Interaction

| Variable Name | Description | 
| :-------------: | :-------------------- |
| Subject | subject number in the study | 
| Metabol | first–pass metabolism of alcohol in the stomach (in mmol/liter-hour) |
| Gastric  | gastric alcohol dehydrogenase activity in the stomach (in mumol/min/g of tissue) | 
| Sex | sex of the subject | 
| Alcohol | whether the subject is alcoholic or not | 


## Data Exploration: Metabolism by Gastric Activity

```{r, echo=F}
library(readr)
library(ggplot2)
metabol <- read_csv("metab.csv")
ggplot(metabol, aes(Gastric, Metabol)) + geom_point() + geom_smooth(method="lm", se=FALSE) + 
  xlab("GAD Activity mumol/min/g") + ylab("Metabolism (mmol/liter-hour)")
```



## Data Exploration: Metabolism by Sex

```{r, echo=F}
ggplot(metabol, aes(Sex, Metabol)) + geom_boxplot()  + 
  xlab("Sex") + ylab("Metabolism (mmol/liter-hour)")
```






## Data Exploration: Metabolism by Alcoholism

```{r, echo=F}
ggplot(metabol, aes(Alcohol, Metabol)) + geom_boxplot()  + 
  xlab("Alcoholism") + ylab("Metabolism (mmol/liter-hour)")
```





## Data Exploration: Metabolism by Gastric and Sex

```{r, echo=F}
ggplot(metabol, aes(Gastric, Metabol, color=Sex)) + geom_point() + geom_smooth(method="lm", se=FALSE) + 
  xlab("GAD Activity mumol/min/g") + ylab("Metabolism (mmol/liter-hour)")
```






## Regression Model

```{r, echo=F}
library(broom)
mod <-  lm(data=metabol, Metabol~Gastric)
tidy(mod, conf.int = TRUE)[,-c(3:4)]
```

## Regression Model

```{r, echo=F}
library(broom)
mod <-  lm(data=metabol, Metabol~Gastric +Sex)
tidy(mod, conf.int = TRUE)[,-c(3:4)]
```


## Regression Model

```{r, echo=F}
library(broom)
mod <-  lm(data=metabol, Metabol~Gastric*Sex)
tidy(mod, conf.int = TRUE)[,-c(3:4)]
```





## Regression Model

```{r, echo=F}
library(broom)
mod <-  lm(data=metabol, Metabol~Gastric +Gastric:Sex)
tidy(mod, conf.int = TRUE)[,-c(3:4)]
```


## Interpretation

- We have to consider the model that we have:

$$Metabolism = \beta_0 + \beta_1 Gastric + \beta_2 Gastric*Male$$
- Females: 
$$ Metabolism = \beta_0 + \beta_1 Gastric$$
- Males:
$$ Metabolism = \beta_0 + (\beta_1+\beta_2) Gastric$$

## Continuous Interaction

- This is a little harder to figure out when it is happening. 
- We have simulated data of GPA based on work ethic and GPA

```{r, echo=F}
set.seed(150)
# 250 subjects    
n <- 250    
# Work ethic average 2.75 
x <- rnorm(n, 2.75, .75)    
#We want a normal distribution of IQ (Z)
z <- rnorm(n, 100, 15)   
#We then create Y using a regression equation (adding a bit of random noise)    
y <- .7*x + 1*z + 7*x*z + rnorm(n, sd = 5)
#Fix GPA so it is max of 4
y = (y - min(y)) / (max(y) - min(y))*4
#Finally, we put our data together with the data.frame() function 
gpa_data <- data.frame(gpa=y, work_ethic=x, iq=z)

```


## Data Exploration

```{r, echo=F}
ggplot(gpa_data, aes(work_ethic, gpa)) + geom_point() + geom_smooth(method="lm", se=FALSE)
```



## Data Exploration

```{r, echo=F}
ggplot(gpa_data, aes(iq, gpa)) + geom_point() + geom_smooth(method="lm", se=FALSE)
```




## Check for Interaction: Try Quantiles

```{r}
gpa_data %>%
  summarise(`0%`=quantile(iq, probs=0),
            `33%`=quantile(iq, probs=0.33),
            `66%`=quantile(iq, probs=0.66),
            `100%`=quantile(iq,probs=1))
```


## Create a Factor

```{r}
gpa_data <-gpa_data %>%
    mutate(iq_fact = cut(iq, 3, labels =c('low', 'medium', 'high')))

```



## Graph Interaction

```{r, echo=F}
ggplot(gpa_data, aes(work_ethic, gpa, color=iq_fact)) + geom_point() + geom_smooth(method="lm", se=FALSE)
```




## Linear Model

```{r}
mod <- lm(data=gpa_data, gpa~work_ethic*iq)
tidy(mod, conf.int = T)[,-c(3:4)]
```