```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(echo=T)
knitr::opts_chunk$set(cache=F)
```
### Homework Guidelines:

Please read [Homework Guidelines](../homework/guidelines.html). You must follow these guidelines. 


### Turning the Homework in:

*Please turn the homework in through canvas. You may use a pdf, html or word doc file to turn the assignment in.*

[PHP 1511 Assignment Link](https://canvas.brown.edu/courses/1075279/assignments/7692220)

[PHP 2511 Assignment Link](https://canvas.brown.edu/courses/1075280/assignments/7692221)


***For the R Markdown Version of this assignment: [HW4.Rmd](../homework/hw5.Rmd)***

We consider in this homework the relationship of cardiometabolic risk factors with the occurrence of colorectal cancer in the Physicians' Health Study.  The data are contains information on 13 variables in a sample of 16,018 participants in the Physicians' Health Study.  These participants were randomized in 1982-1983 and followed until they died, dropped out, developed colorectal cancer, or until 12/31/1995.  

Variables are: 



-----------------------------------------------------------
Name        Description
----------- -------------------------------------------
age         Age in years at time of Randomization

asa         0 - placebo, 1 - aspirin

bmi         Body Mass Index (kg/$m^2$)

hypert      1 - Hypertensive at baseline, 0 - Not

alcohol     0 - less than monthly, 1 - monthly to less than daily, 2 - daily consumption

dm          0 = No diabetes Mellitus, 1 - diabetes Mellitus

sbp         Systolic BP (mmHg)

exer        0 - No regular, 1 - Sweat at least once per week

csmoke      0 - Not currently, 1 - < 1 pack per day, 2 - $\ge$ 1 pack per day

psmoke      0 - never smoked, 1 - former < 1 pack per day, 2 - former $\ge$ 1 pack per day

pkyrs       Total lifetime packs of cigarettes smoked

crc         0 - No colorectal Cancer, 1 - Colorectal cancer

cayrs       Years to colorectal cancer, or death, or end of follow-up.
------------------------------------------------------------------------


```{r}
suppressMessages(library(foreign))
phscrc <- read.dta("https://drive.google.com/uc?export=download&id=0B8CsRLdwqzbzSno1bFF4SUpVQWs")
```


1. Fit a Poisson regression model that predicts the incidence of CRC with the following independent variables: continuous age, continuous SBP, pack-years of cigarettes consumed, continuous BMI and an indicator of diabetes mellitus.  Provide interpretation of the relationship of SBP with rates of CRC from this model, based on comparison of the adjusted relative rate in two men differing by 10 mmHg, with a relevant 95% confidence interval. 
```{r}
library(broom)
#we can create a new variable sbp10 whose unit is 10mmHg.
phscrc$sbp10 <- phscrc$sbp/10
fit1 <- glm(crc ~ age + sbp10 + pkyrs + bmi + as.factor(dm) + offset(log(cayrs)), data = phscrc, family = poisson(link = "log"))
tidy(fit1, exponentiate = T, conf.int = T)[,-c(3,4)]
```

**For two people with the same age, total lifetime packs of cigarettes smoked, bmi, and status of diabetes Mellitus, 10mmHg increase in sbp would lead to an 16.4% increase in CRC rate ratio with a 95% confidence interval of 5.1% and 28.7%**

2. Obtain and plot Kaplan-Meier estimates of the probability of developing CRC among those with and without elevated SBP ($\ge$ 140 mmHg).  Give estimated probabilities of developing CRC at 1, 5, and 10 years in each SBP group.
```{r,fig.width=12, fig.height=8}
phscrc$sbp.grp <- 0
phscrc$sbp.grp[which(phscrc$sbp >= 140)] <- 1
phscrc$sbp.grp <- factor(phscrc$sbp.grp, labels = c("No elevated SBP", "elevated SBP"))
library(survival)
library(survminer)
m1 <- survfit(Surv(cayrs,crc) ~ sbp.grp, data = subset(phscrc, cayrs > 0))
m1
ggsurvplot(m1, conf.int=TRUE, risk.table=TRUE,
           risk.table.col="strata", break.time.by=1, ylim=c(0.95,1))
```

**1 year: with elevated SBP:1 - 2559/2577 = 0.007; without elevated SBP:1 - 13384/13441 = 0.004**

**5 year: with elevated SBP:1- 2418/2577 = 0.062; without elevated SBP:1 - 13076/13441 = 0.027**

**10 year: with elevated SBP:1 - 2070/2577 = 0.197; without elevated SBP:1 - 12171/13441 = 0.094**

3. In question 2, you compared the probability of developing colorectal cancer at 3 different follow-up times (1, 5, and 10 years) between men with and without elevated SBP ($\ge$ 140 mmHg).  Continue with this same dichotomous exposure variable, and perform the log-rank test to compare the hazard of colorectal cancer between the two groups of men.  Make sure you state the null and alternative hypotheses.  

**Null hypothesis: Survival probability of men who don't have elevated SBP equals to Survival probability of men who have elevated SBP all the time.**

**Alternative hypothesis: Survival probability of men who don't have elevated SBP doesn't equal to Survival probability of men who have elevated SBP for some time.**

```{r}
survdiff(Surv(cayrs,crc) ~ sbp.grp, data = subset(phscrc, cayrs>0))
```

**We reject the null hypothesis and accept the alternative hypothesis.**

4. Older age is a powerful risk factor for colorectal cancer that also influences SBP, and is therefore a probable confounder.  Form  four age groups  (40-49, 50-59, 60-69, and 70-84 years) and perform a stratified log-rank test of whether elevated SBP ($\ge$ 140 mmHg) is related to the hazard of colorectal cancer, adjusted for age.

**Null hypothesis: Survival probability of men who don't have elevated SBP equals to Survival probability of men who have elevated SBP all the time, adjusted for age.**

**Alternative hypothesis: Survival probability of men who don't have elevated SBP doesn't equal to Survival probability of men who have elevated SBP for some time, adjusted for age.**

```{r}
library(tidyverse)
library(haven)
phscrc <- phscrc %>%
            mutate(age.cat = cut(age, c(40,50,60,70,85), right=FALSE))

survdiff(Surv(cayrs,crc) ~ sbp.grp + strata(age.cat), data = subset(phscrc, cayrs>0))
```

**We reject the null hypothesis. Elevated SBP is related to the hazard of colorectal cancer, adjusted for age**

5. Evaluate the shape of the relationship of SBP with rates of CRC, **adjusting for age** in a proportional hazards model.  You can use either continuous age or the four categories described above. Create 4 models:

- **Model 1**: Use continuous SBP (We will refer to this as the simple linear model)
```{r}
phscrc <- phscrc[!is.na(phscrc$sbp),]
cox1 <- coxph(Surv(cayrs,crc) ~ sbp + age.cat,
          data = subset(phscrc, cayrs>0))
summary(cox1)
```

- **Model 2**: Use clinical cutpoints of SBP (<120, 120-129, 130-139, $\ge$ 140 mmHg)
```{r}
phscrc <- phscrc %>% mutate(sbp.cat = cut(sbp, c(0,120,130,140,201), right = F))
cox2 <- coxph(Surv(cayrs,crc) ~ sbp.cat + age.cat,
          data = subset(phscrc, cayrs>0))
summary(cox2)
```
- **Model 3**: Quartiles of the distribution
```{r}
phscrc <- phscrc %>% mutate(sbp.qtl = cut(sbp, c(0,quantile(sbp)[2:4],201), right = F))
cox3 <- coxph(Surv(cayrs,crc) ~ sbp.qtl + age.cat,
          data = subset(phscrc, cayrs>0))
summary(cox3)
```
- **Model 4**: Linear plus quadratic term of SBP.  
```{r}
phscrc <- phscrc %>% mutate(sbp2 = sbp^2)
cox4 <- coxph(Surv(cayrs,crc) ~ sbp + sbp2 + age.cat,
          data = subset(phscrc, cayrs>0))
summary(cox4)
```
Does a simple linear model (on the log scale) adequately describe the relationship controlling for age?  You can use Likelihood Ratio tests to compare Models 2-4 vs Model 1. 
```{r}
anova(cox1, cox2, test = "Chisq")
anova(cox1, cox3, test = "Chisq")
anova(cox1, cox4, test = "Chisq")
```

**The P-values of the likelihood ratio test are all larger than 0.05. That is to say, a simple linear model (on the log scale) adequately describe the relationship controlling for age.**

6. Which graphical approaches can you use to evaluate whether the assumptions of the proportional hazards appear to hold?  Obtain these graphs and briefly interpret them.

**We use log-log plot to evaluate whether the assumptions of the proportional hazards appear to hold.**

**First we draw the plot of $age.cat$, the plot shows that the ssumptions of the proportional hazards appear to hold since the lines are basically parallel.**
```{r}
library(ggplot2)
library(ggfortify)
plot(survfit(Surv(cayrs,crc) ~ age.cat, data = subset(phscrc, cayrs > 0)), col=c("black", "red","blue","green"), fun="cloglog", main = "log-log plot of age categories")
```


**Since we can't draw the plot for continuous variable, we draw the plot of $sbp.cat$. The plot shows that the assumptions of the proportional hazards doesn't appear to hold since the lines are not parallel.**
```{r}
plot(survfit(Surv(cayrs,crc) ~ sbp.cat, data = subset(phscrc, cayrs > 0)), col=c("black", "red","blue","green"), fun="cloglog", main = "log-log plot of sbp categories")

```

7. Perform a hypothesis test to evaluate the proportional hazards assumption. 

```{r}
cox.zph(cox1)
```

**Since the p-value is larger than 0.05, the assumptions of the proportional hazards hold.**